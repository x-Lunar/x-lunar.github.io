<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser for AI explanations -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom Scrollbar for code editor */
        textarea {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            tab-size: 2;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        .console-msg {
            border-bottom: 1px solid #333;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .console-log { color: #ccc; }
        .console-warn { color: #fbbf24; background: #292200; }
        .console-error { color: #f87171; background: #2e1010; }
        .console-info { color: #60a5fa; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #ec4899; /* Pink-500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI Markdown Styles */
        .ai-content p { margin-bottom: 0.5em; }
        .ai-content code { background: #333; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .ai-content pre { background: #111; padding: 10px; overflow-x: auto; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body class="bg-zinc-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-14 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-4">
            <a href="index.html" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 px-3 py-1.5 rounded text-sm font-medium flex items-center gap-1 transition-colors border border-zinc-700">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Hub
            </a>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-pink-600 rounded flex items-center justify-center font-bold text-white">p5</div>
                <h1 class="font-semibold text-lg tracking-tight">Studio</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="aiModalBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white px-4 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-all shadow-lg shadow-purple-900/20">
                <i data-lucide="sparkles" class="w-4 h-4 fill-current"></i> AI Assistant
            </button>
            <div class="h-6 w-px bg-zinc-800 mx-1"></div>
            <span class="text-xs text-zinc-500 hidden sm:inline">Ctrl + Enter to Run</span>
            <button id="runBtn" class="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-1.5 rounded text-sm font-medium flex items-center gap-2 transition-colors border border-zinc-700">
                <i data-lucide="play" class="w-4 h-4 fill-current"></i> Run
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col md:flex-row min-h-0 relative">
        
        <!-- Editor Section -->
        <div class="flex-1 flex flex-col border-r border-zinc-800 min-w-0">
            <div class="bg-zinc-900 px-4 py-2 text-xs font-mono text-zinc-400 border-b border-zinc-800 flex justify-between">
                <span>sketch.js</span>
            </div>
            <div class="relative flex-1 bg-[#1e1e1e]">
                <textarea 
                    id="editor" 
                    class="absolute inset-0 w-full h-full bg-transparent text-gray-300 p-4 resize-none focus:outline-none leading-relaxed text-sm"
                    spellcheck="false"
                >function setup() {
  createCanvas(windowWidth, windowHeight);
  background(20);
}

function draw() {
  // Simple interactive particle system
  if (mouseIsPressed) {
    noStroke();
    fill(255, 100, 100, 150);
    circle(mouseX, mouseY, random(10, 30));
  }
  
  // Random static noise
  stroke(255, 50);
  point(random(width), random(height));
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  background(20);
}
</textarea>
            </div>
        </div>

        <!-- Preview & Console Section -->
        <div class="flex-1 flex flex-col min-w-0 bg-zinc-950">
            
            <!-- Canvas Container -->
            <div class="flex-1 relative bg-zinc-800 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]">
                <div class="absolute inset-0 flex items-center justify-center text-zinc-600 pointer-events-none" id="placeholder">
                    <span>Canvas Preview</span>
                </div>
                <iframe id="previewFrame" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin allow-popups allow-modals allow-pointer-lock"></iframe>
            </div>

            <!-- Console -->
            <div class="h-48 flex flex-col border-t border-zinc-800 bg-zinc-900 shrink-0">
                <div class="px-3 py-1.5 bg-zinc-950 border-b border-zinc-800 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="terminal" class="w-3 h-3 text-zinc-400"></i>
                        <span class="text-xs font-medium text-zinc-400">Console</span>
                    </div>
                    <button id="clearConsole" class="text-zinc-500 hover:text-zinc-300 transition-colors">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
                <div id="consoleOutput" class="flex-1 overflow-y-auto p-0 text-sm font-mono scroll-smooth"></div>
            </div>
        </div>

        <!-- AI Modal -->
        <div id="aiModal" class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
            <div class="bg-zinc-900 border border-zinc-700 w-full max-w-lg rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950 rounded-t-xl">
                    <div class="flex items-center gap-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 font-bold text-lg">
                        <i data-lucide="sparkles" class="w-5 h-5 text-pink-500"></i> AI Assistant
                    </div>
                    <button id="closeAiModal" class="text-zinc-500 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-zinc-400 mb-2 uppercase tracking-wide">Ask Gemini</label>
                        <textarea id="aiPrompt" rows="3" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-pink-500 transition-colors resize-none" placeholder="E.g., Draw a recursive tree that sways in the wind, or Explain the current code..."></textarea>
                    </div>

                    <div class="flex gap-2 mb-6">
                        <button id="btnGenerate" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white py-2 rounded-lg text-sm font-medium transition-all flex justify-center items-center gap-2">
                            <span>Generate Sketch âœ¨</span>
                        </button>
                        <button id="btnExplain" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-200 py-2 rounded-lg text-sm font-medium transition-colors border border-zinc-700 flex justify-center items-center gap-2">
                            <span>Explain Code ðŸ§ </span>
                        </button>
                    </div>

                    <!-- AI Output Area -->
                    <div id="aiOutputContainer" class="hidden">
                        <div class="flex items-center gap-2 mb-2 text-xs font-medium text-zinc-400 uppercase tracking-wide">
                            <span>Result</span>
                            <div id="aiLoader" class="loader hidden"></div>
                        </div>
                        <div id="aiResponse" class="bg-zinc-950 border border-zinc-800 rounded-lg p-4 text-sm text-gray-300 ai-content max-h-60 overflow-y-auto">
                            <!-- Response goes here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key Setup Modal -->
        <div id="apiKeyModal" class="absolute inset-0 z-[60] bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4">
            <div class="bg-zinc-900 border border-yellow-500/50 w-full max-w-sm rounded-xl shadow-2xl p-6">
                <h3 class="text-xl font-bold mb-2 text-yellow-400 flex items-center gap-2">
                    <i data-lucide="key" class="w-5 h-5"></i> API Key Required
                </h3>
                <p class="text-sm text-zinc-300 mb-4">
                    To use the AI Assistant, please enter your Gemini API Key. This key is saved locally in your browser.
                </p>
                <input type="text" id="userApiKeyInput" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-yellow-500 transition-colors mb-4" placeholder="Enter your key here (e.g., AIzaSy...)">
                <button id="saveApiKeyBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                    Save Key & Enable AI
                </button>
                <p class="text-xs text-zinc-500 mt-3 text-center">
                    <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="underline hover:text-yellow-400">Get your key from Google AI Studio</a>
                </p>
            </div>
        </div>

    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // Elements
        const editor = document.getElementById('editor');
        const runBtn = document.getElementById('runBtn');
        const previewFrame = document.getElementById('previewFrame');
        const consoleOutput = document.getElementById('consoleOutput');
        const clearConsoleBtn = document.getElementById('clearConsole');
        const placeholder = document.getElementById('placeholder');
        
        // AI Elements
        const aiModalBtn = document.getElementById('aiModalBtn');
        const aiModal = document.getElementById('aiModal');
        const closeAiModal = document.getElementById('closeAiModal');
        const aiPrompt = document.getElementById('aiPrompt');
        const btnGenerate = document.getElementById('btnGenerate');
        const btnExplain = document.getElementById('btnExplain');
        const aiOutputContainer = document.getElementById('aiOutputContainer');
        const aiResponse = document.getElementById('aiResponse');
        const aiLoader = document.getElementById('aiLoader');

        // API Key Elements
        const apiKeyModal = document.getElementById('apiKeyModal');
        const userApiKeyInput = document.getElementById('userApiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');

        // Initial API Key from environment (will be empty on GitHub Pages)
        // Temporary fix: Use the key provided by the user as a fallback default.
        const FALLBACK_API_KEY = "AIzaSyBYHPR6lVP6DDpFt0m_HKoksaAbzZ63_yQ"; 
        let currentApiKey = ""; 

        // --- API KEY MANAGEMENT ---
        
        // Function to load the key from localStorage
        function loadApiKey() {
            const storedKey = localStorage.getItem('geminiApiKey');
            
            // 1. Check if the runtime environment provided a key (e.g., in a development platform)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== "") {
                currentApiKey = __initial_auth_token;
            } 
            // 2. Check local storage (user previously entered it)
            else if (storedKey) {
                currentApiKey = storedKey;
            } 
            // 3. Use the temporary fallback key provided by the user
            else if (FALLBACK_API_KEY) {
                currentApiKey = FALLBACK_API_KEY;
                // Since we're using the fallback, save it to local storage for persistence
                localStorage.setItem('geminiApiKey', FALLBACK_API_KEY);
            } else {
                currentApiKey = ""; 
            }
            updateAiButtonState();
        }

        // Function to update the AI button style based on key availability
        function updateAiButtonState() {
            if (currentApiKey) {
                aiModalBtn.classList.remove('opacity-50', 'bg-zinc-700', 'cursor-not-allowed');
                aiModalBtn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
                aiModalBtn.title = "Open AI Assistant";
            } else {
                aiModalBtn.classList.add('opacity-50', 'bg-zinc-700', 'cursor-not-allowed');
                aiModalBtn.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-600');
                aiModalBtn.title = "API Key required to use AI";
            }
        }

        // Open the AI Modal, but first check for the key
        aiModalBtn.addEventListener('click', () => {
            if (currentApiKey) {
                // If a key is present (either environment, local storage, or fallback), open AI modal
                toggleModal(true);
            } else {
                // If no key is found anywhere, show the API key input modal
                apiKeyModal.classList.remove('hidden');
                userApiKeyInput.focus();
            }
        });

        // Save the key from the modal
        saveApiKeyBtn.addEventListener('click', () => {
            const key = userApiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                currentApiKey = key;
                apiKeyModal.classList.add('hidden');
                updateAiButtonState();
                toggleModal(true); // Open the AI modal after saving
            } else {
                userApiKeyInput.placeholder = "Key cannot be empty!";
                userApiKeyInput.classList.add('border-red-500');
            }
        });

        // --- EDITOR & CONSOLE LOGIC (Unchanged) ---

        // Allow Tab indentation in Textarea
        editor.addEventListener('keydown', function(e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                runSketch();
            }
        });

        function logToConsole(type, args) {
            const row = document.createElement('div');
            row.className = `console-msg console-${type}`;
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try { return JSON.stringify(arg, null, 2); } catch (e) { return '[Circular]'; }
                }
                return String(arg);
            }).join(' ');
            row.textContent = `> ${message}`;
            consoleOutput.appendChild(row);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        clearConsoleBtn.addEventListener('click', () => consoleOutput.innerHTML = '');

        window.addEventListener('message', (event) => {
            if (event.data.source === 'p5-console') {
                logToConsole(event.data.type, event.data.args);
            }
        });

        function runSketch() {
            const code = editor.value;
            placeholder.style.display = 'none';
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: transparent; }
                        canvas { display: block; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
                    </style>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"><\/script>
                    <script>
                        (function() {
                            const originalLog = console.log;
                            const originalWarn = console.warn;
                            const originalError = console.error;
                            const originalInfo = console.info;
                            function send(type, args) {
                                window.parent.postMessage({ source: 'p5-console', type: type, args: Array.from(args) }, '*');
                            }
                            console.log = function(...args) { originalLog.apply(console, args); send('log', args); };
                            console.warn = function(...args) { originalWarn.apply(console, args); send('warn', args); };
                            console.error = function(...args) { originalError.apply(console, args); send('error', args); };
                            console.info = function(...args) { originalInfo.apply(console, args); send('info', args); };
                            window.onerror = function(msg, url, lineNo, columnNo, error) {
                                send('error', [\`Error: \${msg} (Line \${lineNo})\`]); return false; 
                            };
                        })();
                    <\/script>
                </head>
                <body>
                    <script>
                        try { ${code} } catch (err) { console.error(err.message); }
                    <\/script>
                </body>
                </html>
            `;
            previewFrame.srcdoc = html;
        }

        runBtn.addEventListener('click', runSketch);
        setTimeout(() => {
            loadApiKey(); // Load key immediately
            runSketch();
        }, 500); // Initial run


        // --- AI LOGIC ---

        function toggleModal(show) {
            if (show) {
                aiModal.classList.remove('hidden');
                aiPrompt.focus();
            } else {
                aiModal.classList.add('hidden');
            }
        }

        closeAiModal.addEventListener('click', () => toggleModal(false));
        aiModal.addEventListener('click', (e) => {
            if (e.target === aiModal) toggleModal(false);
        });

        async function callGemini(systemPrompt, userPrompt) {
            if (!currentApiKey) return "Error: Gemini API Key is missing. Please enter your key to enable the AI features.";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            // Exponential backoff
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 400) {
                        const errorData = await response.json();
                        // This specific error might mean the key is invalid or quota is exceeded
                        return `API Error: ${errorData.error.message || 'Check your API key and quota.'}`;
                    }
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated. The model may have refused the prompt.";
                } catch (error) {
                    if (i === 4) return `Network Error: ${error.message}. Please check your connection or try again later.`;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function handleGenerate() {
            const prompt = aiPrompt.value.trim();
            if (!prompt) return;
            if (!currentApiKey) {
                aiModal.classList.add('hidden');
                apiKeyModal.classList.remove('hidden');
                return;
            }

            // UI State
            btnGenerate.disabled = true;
            btnGenerate.classList.add('opacity-50');
            aiLoader.classList.remove('hidden');
            aiOutputContainer.classList.remove('hidden');
            aiResponse.innerHTML = '<span class="text-zinc-500 italic">Dreaming up code...</span>';

            const systemPrompt = `You are an expert creative coder using p5.js. 
            Your task is to write a COMPLETE, RUNNABLE p5.js sketch based on the user's description.
            - Provide ONLY valid JavaScript code.
            - Do NOT wrap code in markdown blocks (no \`\`\`js ... \`\`\`).
            - Do NOT add explanations outside the code.
            - Ensure you include function setup() and function draw().
            - If the user asks for 3D, use WEBGL mode.
            - Make the sketch visually interesting and handle windowResized() if possible.`;

            const result = await callGemini(systemPrompt, prompt);
            
            // Handle API errors
            if (result.startsWith("Error:") || result.startsWith("API Error:") || result.startsWith("Network Error:")) {
                aiResponse.innerHTML = `<span class="text-red-400">${result}</span>`;
            } else {
                // Success: Process and run code
                let cleanCode = result.replace(/```javascript/g, '').replace(/```js/g, '').replace(/```/g, '').trim();

                aiResponse.innerHTML = `<span class="text-green-400">Sketch generated successfully! Loading into editor...</span>`;
                
                // Update editor and run
                editor.value = cleanCode;
                runSketch();
                
                // Close modal after a delay
                setTimeout(() => {
                    toggleModal(false);
                    aiResponse.innerHTML = '';
                    aiOutputContainer.classList.add('hidden');
                }, 1500);
            }

            // Reset UI
            btnGenerate.disabled = false;
            btnGenerate.classList.remove('opacity-50');
            aiLoader.classList.add('hidden');
        }

        async function handleExplain() {
            const code = editor.value;
            if (!currentApiKey) {
                aiModal.classList.add('hidden');
                apiKeyModal.classList.remove('hidden');
                return;
            }
            
            // UI State
            btnExplain.disabled = true;
            btnExplain.classList.add('opacity-50');
            aiLoader.classList.remove('hidden');
            aiOutputContainer.classList.remove('hidden');
            aiResponse.innerHTML = '<span class="text-zinc-500 italic">Analyzing code...</span>';

            const systemPrompt = `You are a helpful p5.js tutor. 
            Explain the following code concisely to a beginner/intermediate creative coder.
            Highlight the key techniques used (e.g., loops, transformations, arrays).
            Use Markdown for formatting.`;

            const prompt = `Here is my p5.js code:\n\n${code}\n\nCan you explain how it works?`;

            const result = await callGemini(systemPrompt, prompt);
            
            if (result.startsWith("Error:") || result.startsWith("API Error:") || result.startsWith("Network Error:")) {
                aiResponse.innerHTML = `<span class="text-red-400">${result}</span>`;
            } else {
                // Render Markdown
                aiResponse.innerHTML = marked.parse(result);
            }

            // Reset UI
            btnExplain.disabled = false;
            btnExplain.classList.remove('opacity-50');
            aiLoader.classList.add('hidden');
        }

        btnGenerate.addEventListener('click', handleGenerate);
        btnExplain.addEventListener('click', handleExplain);

    </script>
</body>
</html>
